package builtin

import (
	"testing"

	"github.com/LatticeBCLab/go-lattice/common/types"
	"github.com/stretchr/testify/assert"
)

func TestNodeCertManagerContract_Encode(t *testing.T) {
	contract := NewNodeCertManagerContract()

	t.Run("Revoke cert", func(t *testing.T) {
		sn := "109313213476126583182290498689290247244"
		actual, err := contract.Revoke([]string{sn})
		assert.NoError(t, err)
		expect := "0x420b3bd10000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000523cf58890fa44499270fb81ac549c4c"
		assert.Equal(t, expect, actual)
	})

	t.Run("Upload cert", func(t *testing.T) {
		pubkey := "0x04085285519fdab5ff8026a6b55e82d552606d97b1e89a32539186808b4f9dbad6b4f2a582ff649e42e69c66765b75024cfb2434c3a89b23d06fbf1e056bef3ff6"
		actual, err := contract.UploadKey([]string{pubkey})
		assert.NoError(t, err)
		expect := "0x1d1ec7320000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004104085285519fdab5ff8026a6b55e82d552606d97b1e89a32539186808b4f9dbad6b4f2a582ff649e42e69c66765b75024cfb2434c3a89b23d06fbf1e056bef3ff600000000000000000000000000000000000000000000000000000000000000"
		assert.Equal(t, expect, actual)
	})

	t.Run("Apply cert", func(t *testing.T) {
		address := "zltc_bnZanacKt9iJZ7mUycFrLYLuZQ8idk63f"
		actual, err := contract.Apply(types.NodeCertificateTypeClient.ToUint(), "zkjg.cn", []string{address})
		assert.NoError(t, err)
		expect := "0xf31f88740000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000077a6b6a672e636e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000007d9231857302ac5437b621215b975181c9f61b1d"
		assert.Equal(t, expect, actual)
	})
}
